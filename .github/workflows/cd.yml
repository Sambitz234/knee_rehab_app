name: CD Pipeline

on:
  push:
    branches: [ main, "fixing-cd" ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dev dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: pytest --cov=src --cov-report=xml

  build-and-push:
    name: Build and Push Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name != 'pull_request'

    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
    
      - name: Set image repo lower-case and Setup Docker Buildx
        run: |
          # make repository name lower-case for registry compatibility
          IMAGE_NAME_LC=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_NAME_LC=$IMAGE_NAME_LC" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # if GHCR write blocked, create PAT and store as GHCR_TOKEN

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME_LC }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to VM via SSH
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/fixing-cd'
    environment: production

    steps:
      - name: Deploy to VM via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          host: ${{ vars.VM_HOST }}
          username: ${{ vars.VM_USERNAME }}
          key: ${{ secrets.VM_SSH_PRIVATE_KEY }}
          envs: REGISTRY,IMAGE_NAME,IMAGE_NAME_LC,GITHUB_TOKEN
          script: |
            set -euo pipefail

            # Ensure docker available; if docker needs sudo, uncomment next line:
            # SUDO="sudo"
            SUDO=""

            echo "Logging in to GHCR"
            echo "$GITHUB_TOKEN" | ${SUDO} docker login ghcr.io -u "${{ github.actor }}" --password-stdin

            IMAGE="${REGISTRY}/${IMAGE_NAME_LC}:latest"
            echo "Pulling image $IMAGE"
            ${SUDO} docker pull "$IMAGE"

            echo "Stopping existing container (if any)"
            ${SUDO} docker stop kneerehab_app || true
            ${SUDO} docker rm kneerehab_app || true

            echo "Starting container"
            ${SUDO} docker run -d \
              --name kneerehab_app \
              --restart unless-stopped \
              -p 8000:8000 \
              -e APP_VERSION="${{ github.sha }}" \
              "$IMAGE"

            echo "Cleaning up dangling images"
            ${SUDO} docker image prune -f

            # wait-for-health up to 60s
            for i in $(seq 1 60); do
              if curl -sfS "http://${{ vars.VM_HOST }}:8000/health" >/dev/null 2>&1; then
                echo "App healthy after $i seconds"
                break
              fi
              sleep 1
            done

            if ! curl -sfS "http://${{ vars.VM_HOST }}:8000/health" >/dev/null 2>&1; then
              echo "Final health check failed"
              ${SUDO} docker logs kneerehab_app || true
              exit 1
            fi

      - name: Deployment summary
        run: |
          echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Application URL:** http://${{ vars.VM_HOST }}:8000" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- Health: http://${{ vars.VM_HOST }}:8000/health" >> $GITHUB_STEP_SUMMARY
          echo "- Metrics: http://${{ vars.VM_HOST }}:8000/metrics" >> $GITHUB_STEP_SUMMARY